<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成图片画廊 - ComfyUI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .gallery-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .gallery-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .gallery-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .gallery-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .gallery-item:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .gallery-item-info {
            padding: 15px;
        }
        
        .gallery-item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .gallery-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .gallery-item-parameters {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
        }
        
        .parameter-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .parameter-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .parameter-value {
            color: var(--text-secondary);
        }
        
        .metadata-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .metadata-modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .metadata-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .metadata-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .metadata-section {
            margin-bottom: 20px;
        }
        
        .metadata-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .metadata-item {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
        }
        
        .metadata-item-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .metadata-item-value {
            color: var(--text-secondary);
            word-break: break-word;
        }
        
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .gallery-item-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .loading-gallery {
            text-align: center;
            padding: 50px;
        }
        
        .empty-gallery {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="gallery-container">
        <div class="gallery-header">
            <h1><i class="fas fa-images"></i> 生成图片画廊</h1>
            <p>查看所有通过ComfyUI生成的图片</p>
        </div>
        
        <div class="gallery-stats" id="galleryStats">
            <div class="stat-item">
                <i class="fas fa-images"></i>
                <span id="totalImages">-</span> 张图片
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span id="latestImage">-</span>
            </div>
        </div>
        
        <div id="galleryContent">
            <div class="loading-gallery">
                <div class="spinner"></div>
                <p>正在加载图片...</p>
            </div>
        </div>
    </div>
    
    <button class="btn btn-primary refresh-btn" onclick="loadGallery()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- 元数据模态框 -->
    <div id="metadataModal" class="metadata-modal">
        <div class="metadata-modal-content">
            <div class="metadata-modal-header">
                <h2><i class="fas fa-info-circle"></i> 图片生成参数</h2>
                <button class="metadata-modal-close" onclick="closeMetadataModal()">&times;</button>
            </div>
            <div id="metadataContent">
                <!-- 元数据内容将在这里动态加载 -->
            </div>
        </div>
    </div>

    <script>
        async function loadGallery() {
            const galleryContent = document.getElementById('galleryContent');
            const totalImages = document.getElementById('totalImages');
            const latestImage = document.getElementById('latestImage');
            
            try {
                galleryContent.innerHTML = `
                    <div class="loading-gallery">
                        <div class="spinner"></div>
                        <p>正在加载图片...</p>
                    </div>
                `;
                
                const response = await fetch('/api/generated-images');
                const data = await response.json();
                
                if (data.success) {
                    const images = data.images;
                    
                    // 更新统计信息
                    totalImages.textContent = data.total;
                    if (images.length > 0) {
                        const latest = new Date(images[0].modified_time);
                        latestImage.textContent = latest.toLocaleString();
                    }
                    
                    if (images.length === 0) {
                        galleryContent.innerHTML = `
                            <div class="empty-gallery">
                                <i class="fas fa-images" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                <h3>暂无生成图片</h3>
                                <p>开始使用ComfyUI生成您的第一张图片吧！</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 20px;">
                                    <i class="fas fa-play"></i> 开始生成
                                </a>
                            </div>
                        `;
                        return;
                    }
                    
                    // 渲染图片网格
                    const galleryGrid = document.createElement('div');
                    galleryGrid.className = 'gallery-grid';
                    
                    images.forEach(image => {
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        
                        const createdTime = new Date(image.modified_time);
                        const fileSize = (image.size / 1024 / 1024).toFixed(1);
                        
                        // 构建参数显示
                        let parametersHtml = '';
                        if (image.has_metadata && (image.prompt || image.steps || image.cfg || image.seed)) {
                            // 处理种子显示
                            let seedDisplay = '';
                            if (image.seed !== undefined && image.seed !== null) {
                                if (image.seed === -1 && image.metadata && image.metadata.parameters && image.metadata.parameters.actual_seed) {
                                    // 用户设置-1，显示实际种子值
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed} → ${image.metadata.parameters.actual_seed}</span></div>`;
                                } else {
                                    // 用户设置了具体值
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed}</span></div>`;
                                }
                            }
                            
                            // 检查是否有模型信息
                            let modelInfo = '';
                            if (image.metadata && image.metadata.parameters && image.metadata.parameters.model_loaders) {
                                const modelLoaders = image.metadata.parameters.model_loaders;
                                // 提取主要模型信息
                                const mainModel = modelLoaders.model_path_45 || modelLoaders.model_type_44 || 'N/A';
                                const vae = modelLoaders.vae_name_10 || 'N/A';
                                modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}</span></div>`;
                            }
                            
                            parametersHtml = `
                                <div class="gallery-item-parameters">
                                    ${image.prompt ? `<div class="parameter-item"><span class="parameter-label">Prompt:</span><span class="parameter-value">${image.prompt.substring(0, 50)}${image.prompt.length > 50 ? '...' : ''}</span></div>` : ''}
                                    ${image.steps ? `<div class="parameter-item"><span class="parameter-label">Steps:</span><span class="parameter-value">${image.steps}</span></div>` : ''}
                                    ${image.cfg ? `<div class="parameter-item"><span class="parameter-label">CFG:</span><span class="parameter-value">${image.cfg}</span></div>` : ''}
                                    ${seedDisplay}
                                    ${image.sampler ? `<div class="parameter-item"><span class="parameter-label">Sampler:</span><span class="parameter-value">${image.sampler}</span></div>` : ''}
                                    ${modelInfo}
                                </div>
                            `;
                        }
                        
                        item.innerHTML = `
                            <img src="${image.url}" alt="${image.filename}" onclick="viewImage('${image.url}')">
                            <div class="gallery-item-info">
                                <div class="gallery-item-title">${image.filename}</div>
                                <div class="gallery-item-meta">
                                    <div>生成时间: ${createdTime.toLocaleString()}</div>
                                    <div>文件大小: ${fileSize} MB</div>
                                    ${image.workflow ? `<div>工作流: ${image.workflow}</div>` : ''}
                                </div>
                                ${parametersHtml}
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-primary" onclick="viewImage('${image.url}')">
                                        <i class="fas fa-eye"></i> 查看
                                    </button>
                                    ${image.has_metadata ? `<button class="btn btn-sm btn-info" onclick="viewMetadata('${image.filename}')">
                                        <i class="fas fa-info-circle"></i> 参数
                                    </button>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="downloadImage('${image.url}')">
                                        <i class="fas fa-download"></i> 下载
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        galleryGrid.appendChild(item);
                    });
                    
                    galleryContent.innerHTML = '';
                    galleryContent.appendChild(galleryGrid);
                } else {
                    throw new Error(data.error || '加载失败');
                }
            } catch (error) {
                console.error('加载画廊失败:', error);
                galleryContent.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>加载失败</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadGallery()">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>
                `;
            }
        }
        
        function viewImage(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        function downloadImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageUrl.split('/').pop() || 'generated_image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 按节点分组模型加载器信息
        function groupModelLoaders(modelLoaders) {
            const groups = {
                'vae': [],
                'text_encoder': [],
                'main_model': [],
                'lora_1': [],
                'lora_2': []
            };
            
            // 定义节点映射
            const nodeMappings = {
                '10': 'vae',
                '44': 'text_encoder', 
                '45': 'main_model',
                '46': 'lora_1',
                '47': 'lora_2'
            };
            
            // 按节点分组
            Object.entries(modelLoaders).forEach(([key, value]) => {
                // 提取节点编号
                const nodeMatch = key.match(/_(\d+)$/);
                if (nodeMatch) {
                    const nodeId = nodeMatch[1];
                    const groupKey = nodeMappings[nodeId];
                    if (groupKey) {
                        groups[groupKey].push({ key, value });
                    }
                }
            });
            
            // 生成分组HTML
            let html = '';
            
            // VAE节点 (10)
            if (groups.vae.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #007bff; margin: 0 0 8px 0; font-size: 14px;">🔧 VAE节点 (节点10)</h4>';
                groups.vae.forEach(({ key, value }) => {
                    const cleanKey = key.replace('_10', '').replace(/_/g, ' ');
                    html += `<div style="margin: 2px 0;"><strong>${cleanKey}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }
            
            // 文本编码器节点 (44)
            if (groups.text_encoder.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #28a745; margin: 0 0 8px 0; font-size: 14px;">📝 文本编码器节点 (节点44)</h4>';
                groups.text_encoder.forEach(({ key, value }) => {
                    const cleanKey = key.replace('_44', '').replace(/_/g, ' ');
                    html += `<div style="margin: 2px 0;"><strong>${cleanKey}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }
            
            // 主模型节点 (45)
            if (groups.main_model.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #dc3545; margin: 0 0 8px 0; font-size: 14px;">🤖 主模型节点 (节点45)</h4>';
                groups.main_model.forEach(({ key, value }) => {
                    const cleanKey = key.replace('_45', '').replace(/_/g, ' ');
                    html += `<div style="margin: 2px 0;"><strong>${cleanKey}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }
            
            // LoRA 1节点 (46)
            if (groups.lora_1.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #ffc107; margin: 0 0 8px 0; font-size: 14px;">🎨 LoRA 1节点 (节点46)</h4>';
                groups.lora_1.forEach(({ key, value }) => {
                    const cleanKey = key.replace('_46', '').replace(/_/g, ' ');
                    html += `<div style="margin: 2px 0;"><strong>${cleanKey}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }
            
            // LoRA 2节点 (47)
            if (groups.lora_2.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #17a2b8; margin: 0 0 8px 0; font-size: 14px;">🎨 LoRA 2节点 (节点47)</h4>';
                groups.lora_2.forEach(({ key, value }) => {
                    const cleanKey = key.replace('_47', '').replace(/_/g, ' ');
                    html += `<div style="margin: 2px 0;"><strong>${cleanKey}:</strong> ${value}</div>`;
                });
                html += '</div>';
            }
            
            return html;
        }
        
        async function viewMetadata(filename) {
            try {
                const response = await fetch(`/api/image-metadata/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    const metadata = data.metadata;
                    const metadataContent = document.getElementById('metadataContent');
                    
                    // 构建元数据HTML
                    let html = '';
                    
                    // 基本信息
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-file-image"></i> 基本信息</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">文件名</div>
                                    <div class="metadata-item-value">${metadata.output_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">工作流</div>
                                    <div class="metadata-item-value">${metadata.workflow_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">任务ID</div>
                                    <div class="metadata-item-value">${metadata.task_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">创建时间</div>
                                    <div class="metadata-item-value">${new Date(metadata.created_time).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 生成参数
                    const parameters = metadata.parameters || {};
                    if (Object.keys(parameters).length > 0) {
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-cogs"></i> 生成参数</h3>
                                <div class="metadata-grid">
                        `;
                        
                        // 显示所有参数
                        for (const [key, value] of Object.entries(parameters)) {
                            if (value !== null && value !== undefined && value !== '') {
                                // 特殊处理种子显示
                                if (key === 'seed' && parameters.user_seed === -1 && parameters.actual_seed) {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">用户设置种子</div>
                                            <div class="metadata-item-value">${parameters.user_seed}</div>
                                        </div>
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">实际使用种子</div>
                                            <div class="metadata-item-value">${parameters.actual_seed}</div>
                                        </div>
                                    `;
                                } else if (key === 'user_seed' || key === 'actual_seed') {
                                    // 跳过这些字段，因为已经在上面处理了
                                    continue;
                                } else if (key === 'model_loaders') {
                                    // 特殊处理model_loaders对象，按节点分组
                                    const groupedModelLoaders = groupModelLoaders(value);
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">模型加载器</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>点击查看详细模型配置</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${groupedModelLoaders}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else if (typeof value === 'object') {
                                    // 处理其他对象类型
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>点击查看详细内容</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${JSON.stringify(value, null, 2)}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">${value}</div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // 技术信息
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-microchip"></i> 技术信息</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">输出节点ID</div>
                                    <div class="metadata-item-value">${metadata.node_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">存储位置</div>
                                    <div class="metadata-item-value">${metadata.subfolder ? `子文件夹: ${metadata.subfolder}` : '根目录'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">输出类型</div>
                                    <div class="metadata-item-value">${metadata.img_type === 'output' ? '生成输出' : metadata.img_type || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">ComfyUI文件名</div>
                                    <div class="metadata-item-value">${metadata.original_filename || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    metadataContent.innerHTML = html;
                    document.getElementById('metadataModal').style.display = 'block';
                } else {
                    alert('获取元数据失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('获取元数据失败:', error);
                alert('获取元数据失败: ' + error.message);
            }
        }
        
        function closeMetadataModal() {
            document.getElementById('metadataModal').style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('metadataModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // 页面加载时自动加载画廊
        document.addEventListener('DOMContentLoaded', loadGallery);
        
        // 每30秒自动刷新一次
        setInterval(loadGallery, 30000);
    </script>
</body>
</html> 