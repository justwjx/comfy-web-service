<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成图片画廊 - ComfyUI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .gallery-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .gallery-header-nav {
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            transform: translateX(-2px);
            text-decoration: none;
        }
        
        .gallery-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .gallery-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .gallery-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .gallery-item:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .gallery-item-info {
            padding: 15px;
        }
        
        .gallery-item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .gallery-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .gallery-item-parameters {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
        }
        
        .parameter-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .parameter-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .parameter-value {
            color: var(--text-secondary);
        }
        
        .metadata-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .metadata-modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .metadata-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .metadata-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .metadata-section {
            margin-bottom: 20px;
        }
        
        .metadata-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .metadata-item {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
        }
        
        .metadata-item-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .metadata-item-value {
            color: var(--text-secondary);
            word-break: break-word;
        }
        
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .gallery-item-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .loading-gallery {
            text-align: center;
            padding: 50px;
        }
        
        .empty-gallery {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        /* 批量操作样式 */
        .batch-actions {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        
        .batch-info {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .batch-buttons {
            display: flex;
            gap: 8px;
        }
        
        .batch-buttons .btn {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        /* 图片选择样式 */
        .gallery-item.selected {
            box-shadow: 0 0 0 3px var(--primary-color);
            transform: scale(0.98);
        }
        
        .gallery-item-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .gallery-item-checkbox input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .gallery-item {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="gallery-container">
        <div class="gallery-header">
            <div class="gallery-header-nav">
                <a href="/" class="btn btn-secondary back-btn">
                    <i class="fas fa-arrow-left"></i>
                    返回工作流
                </a>
            </div>
            <h1><i class="fas fa-images"></i> 生成图片画廊</h1>
            <p>查看所有通过ComfyUI生成的图片</p>
            <div style="font-size:11px;color:var(--text-secondary);opacity:.8;margin-top:6px;">
                小贴士：点击图片可新窗口查看原图；点击“参数”可展开生成时的提示词与模型配置。
            </div>
        </div>
        
        <div class="gallery-stats" id="galleryStats">
            <div class="stat-item">
                <i class="fas fa-images"></i>
                <span id="totalImages">-</span> 张图片
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span id="latestImage">-</span>
            </div>
        </div>
        
        <!-- 批量操作栏 -->
        <div class="batch-actions" id="batchActions" style="display: none;">
            <div class="batch-info">
                <span id="selectedCount">0</span> 张图片已选中
            </div>
            <div class="batch-buttons">
                <button class="btn btn-secondary btn-sm" onclick="selectAllImages()">
                    <i class="fas fa-check-square"></i>
                    全选
                </button>
                <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
                    <i class="fas fa-times"></i>
                    清除选择
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedImages()">
                    <i class="fas fa-trash"></i>
                    删除选中
                </button>
            </div>
        </div>
        
        <div id="galleryContent">
            <div class="loading-gallery">
                <div class="spinner"></div>
                <p>正在加载图片...</p>
            </div>
        </div>
    </div>
    
    <button class="btn btn-primary refresh-btn" onclick="loadGallery()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- 元数据模态框 -->
    <div id="metadataModal" class="metadata-modal">
        <div class="metadata-modal-content">
            <div class="metadata-modal-header">
                <h2><i class="fas fa-info-circle"></i> 图片生成参数</h2>
                <button class="metadata-modal-close" onclick="closeMetadataModal()">&times;</button>
            </div>
            <div id="metadataContent">
                <!-- 元数据内容将在这里动态加载 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let selectedImages = new Set();
        let allImages = [];
        
        async function loadGallery() {
            const galleryContent = document.getElementById('galleryContent');
            const totalImages = document.getElementById('totalImages');
            const latestImage = document.getElementById('latestImage');
            
            try {
                galleryContent.innerHTML = `
                    <div class="loading-gallery">
                        <div class="spinner"></div>
                        <p>正在加载图片...</p>
                    </div>
                `;
                
                const response = await fetch('/api/generated-images');
                const data = await response.json();
                
                if (data.success) {
                    const images = data.images;
                    allImages = images; // 保存到全局变量
                    
                    // 更新统计信息
                    totalImages.textContent = data.total;
                    if (images.length > 0) {
                        const latest = new Date(images[0].modified_time);
                        latestImage.textContent = latest.toLocaleString();
                    }
                    
                    if (images.length === 0) {
                        galleryContent.innerHTML = `
                            <div class="empty-gallery">
                                <i class="fas fa-images" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                <h3>暂无生成图片</h3>
                                <p>开始使用ComfyUI生成您的第一张图片吧！</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 20px;">
                                    <i class="fas fa-play"></i> 开始生成
                                </a>
                            </div>
                        `;
                        return;
                    }
                    
                    // 渲染图片网格
                    const galleryGrid = document.createElement('div');
                    galleryGrid.className = 'gallery-grid';
                    
                    images.forEach(image => {
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        
                        const createdTime = new Date(image.modified_time);
                        const fileSize = (image.size / 1024 / 1024).toFixed(1);
                        
                        // 构建参数显示
                        let parametersHtml = '';
                        if (image.has_metadata && (image.prompt || image.steps || image.cfg || image.seed)) {
                            // 处理种子显示
                            let seedDisplay = '';
                            if (image.seed !== undefined && image.seed !== null) {
                                if (image.seed === -1 && image.metadata && image.metadata.parameters && image.metadata.parameters.actual_seed) {
                                    // 用户设置-1，显示实际种子值
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed} → ${image.metadata.parameters.actual_seed}</span></div>`;
                                } else {
                                    // 用户设置了具体值
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed}</span></div>`;
                                }
                            }
                            
                            // 检查是否有模型信息
                            let modelInfo = '';
                            // 兼容：优先读取新的 model_summary / 其次读取 model_loaders(by_node)
                            if (image.metadata) {
                                if (image.metadata.model_summary) {
                                    const ms = image.metadata.model_summary;
                                    const mainModel = ms.main_model || 'N/A';
                                    const vae = ms.vae || null;
                                    const loras = Array.isArray(ms.loras) ? ms.loras.filter(Boolean) : [];
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}${loras.length ? ` | LoRA: ${loras.slice(0,2).join(', ')}${loras.length>2?'…':''}` : ''}</span></div>`;
                                } else if (image.metadata.model_loaders) {
                                    const ml = image.metadata.model_loaders; // by_node 展开
                                    const mainModel = ml.model_path_45 || ml.ckpt_name_45 || ml.model_type_44 || 'N/A';
                                    const vae = ml.vae_name_10 || null;
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}</span></div>`;
                                } else if (image.metadata.parameters && image.metadata.parameters.model_loaders) {
                                    // 旧结构向后兼容
                                    const ml = image.metadata.parameters.model_loaders;
                                    const mainModel = ml.model_path_45 || ml.ckpt_name_45 || ml.model_type_44 || 'N/A';
                                    const vae = ml.vae_name_10 || null;
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}</span></div>`;
                                }
                            }
                            
                            parametersHtml = `
                                <div class="gallery-item-parameters">
                                    ${image.prompt ? `<div class="parameter-item"><span class="parameter-label">Prompt:</span><span class="parameter-value">${image.prompt.substring(0, 50)}${image.prompt.length > 50 ? '...' : ''}</span></div>` : ''}
                                    ${image.steps ? `<div class="parameter-item"><span class="parameter-label">Steps:</span><span class="parameter-value">${image.steps}</span></div>` : ''}
                                    ${image.cfg ? `<div class="parameter-item"><span class="parameter-label">CFG:</span><span class="parameter-value">${image.cfg}</span></div>` : ''}
                                    ${seedDisplay}
                                    ${image.sampler ? `<div class="parameter-item"><span class="parameter-label">Sampler:</span><span class="parameter-value">${image.sampler}</span></div>` : ''}
                                    ${modelInfo}
                                </div>
                            `;
                        }
                        
                        item.innerHTML = `
                            <div class="gallery-item-checkbox">
                                <input type="checkbox" onchange="toggleImageSelection('${image.filename}', this)" />
                            </div>
                            <img src="${image.url}" alt="${image.filename}" onclick="viewImage('${image.url}')">
                            <div class="gallery-item-info">
                                <div class="gallery-item-title">${image.filename}</div>
                                <div class="gallery-item-meta">
                                    <div>生成时间: ${createdTime.toLocaleString()}</div>
                                    <div>文件大小: ${fileSize} MB</div>
                                    ${image.workflow ? `<div>工作流: ${image.workflow}</div>` : ''}
                                </div>
                                ${parametersHtml}
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-primary" onclick="viewImage('${image.url}')">
                                        <i class="fas fa-eye"></i> 查看
                                    </button>
                                    ${image.has_metadata ? `<button class="btn btn-sm btn-info" onclick="viewMetadata('${image.filename}')">
                                        <i class="fas fa-info-circle"></i> 参数
                                    </button>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="downloadImage('${image.url}')">
                                        <i class="fas fa-download"></i> 下载
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.filename}')">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        galleryGrid.appendChild(item);
                    });
                    
                    galleryContent.innerHTML = '';
                    galleryContent.appendChild(galleryGrid);
                } else {
                    throw new Error(data.error || '加载失败');
                }
            } catch (error) {
                console.error('加载画廊失败:', error);
                galleryContent.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>加载失败</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadGallery()">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>
                `;
            }
        }
        
        function viewImage(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        function downloadImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageUrl.split('/').pop() || 'generated_image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 通用分组（不依赖固定节点ID），更好适配不同工作流
        function groupModelLoaders(modelLoaders) {
            const groups = {
                vae: [],
                main_model: [],
                text_encoder: [],
                lora: [],
                other: []
            };

            Object.entries(modelLoaders).forEach(([key, value]) => {
                const lower = String(key).toLowerCase();
                if (lower.startsWith('vae_name_')) {
                    groups.vae.push({ key, value });
                } else if (lower.startsWith('model_path_') || lower.startsWith('ckpt_name_')) {
                    groups.main_model.push({ key, value });
                } else if (lower.startsWith('clip_name') || lower.startsWith('text_encoder')) {
                    groups.text_encoder.push({ key, value });
                } else if (lower.startsWith('lora_name_')) {
                    groups.lora.push({ key, value });
                } else {
                    groups.other.push({ key, value });
                }
            });

            let html = '';
            const renderBlock = (title, color, items) => {
                if (!items || items.length === 0) return '';
                let block = `<div style="margin-bottom: 15px;"><h4 style="color: ${color}; margin: 0 0 8px 0; font-size: 14px;">${title}</h4>`;
                items.forEach(({ key, value }) => {
                    block += `<div style="margin: 2px 0;"><strong>${key.replace(/_/g, ' ')}:</strong> ${value}</div>`;
                });
                block += '</div>';
                return block;
            };

            html += renderBlock('🔧 VAE', '#007bff', groups.vae);
            html += renderBlock('🤖 主模型', '#dc3545', groups.main_model);
            html += renderBlock('📝 文本编码器', '#28a745', groups.text_encoder);
            html += renderBlock('🎨 LoRA', '#ffc107', groups.lora);
            html += renderBlock('📦 其他', '#6c757d', groups.other);

            return html || '<div style="color: var(--text-secondary);">无可展示的模型配置</div>';
        }
        
        async function viewMetadata(filename) {
            try {
                const response = await fetch(`/api/image-metadata/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    const metadata = data.metadata;
                    const metadataContent = document.getElementById('metadataContent');
                    
                    // 构建元数据HTML
                    let html = '';
                    
                    // 基本信息
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-file-image"></i> 基本信息</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">文件名</div>
                                    <div class="metadata-item-value">${metadata.output_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">工作流</div>
                                    <div class="metadata-item-value">${metadata.workflow_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">任务ID</div>
                                    <div class="metadata-item-value">${metadata.task_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">创建时间</div>
                                    <div class="metadata-item-value">${new Date(metadata.created_time).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 生成参数
                    const parameters = metadata.parameters || {};
                    if (Object.keys(parameters).length > 0) {
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-cogs"></i> 生成参数</h3>
                                <div class="metadata-grid">
                        `;
                        
                        // 显示所有参数
                        for (const [key, value] of Object.entries(parameters)) {
                            if (value !== null && value !== undefined && value !== '') {
                                // 特殊处理种子显示
                                if (key === 'seed' && parameters.user_seed === -1 && parameters.actual_seed) {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">用户设置种子</div>
                                            <div class="metadata-item-value">${parameters.user_seed}</div>
                                        </div>
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">实际使用种子</div>
                                            <div class="metadata-item-value">${parameters.actual_seed}</div>
                                        </div>
                                    `;
                                } else if (key === 'user_seed' || key === 'actual_seed') {
                                    // 跳过这些字段，因为已经在上面处理了
                                    continue;
                                } else if (key === 'model_loaders') {
                                    // 特殊处理model_loaders对象，按节点分组
                                    const groupedModelLoaders = groupModelLoaders(value);
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">模型加载器</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>点击查看详细模型配置</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${groupedModelLoaders}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else if (typeof value === 'object') {
                                    // 处理其他对象类型
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>点击查看详细内容</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${JSON.stringify(value, null, 2)}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">${value}</div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // 模型摘要（优先显示）
                    if (metadata.model_summary) {
                        const ms = metadata.model_summary;
                        const loras = Array.isArray(ms.loras) ? ms.loras.filter(Boolean) : [];
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-layer-group"></i> 模型加载器（摘要）</h3>
                                <div class="metadata-grid">
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">主模型</div>
                                        <div class="metadata-item-value">${ms.main_model || 'N/A'}</div>
                                    </div>
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">VAE</div>
                                        <div class="metadata-item-value">${ms.vae || 'N/A'}</div>
                                    </div>
                                    ${loras.length ? `
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">LoRA</div>
                                        <div class="metadata-item-value">${loras.join(', ')}</div>
                                    </div>` : ''}
                                </div>
                            </div>
                        `;
                    }

                    // 详细模型加载器（by_node 提示）
                    if (metadata.model_loaders && typeof metadata.model_loaders === 'object') {
                        const groupedModelLoaders = groupModelLoaders(metadata.model_loaders);
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-tools"></i> 模型加载器（详细）</h3>
                                <div class="metadata-grid">
                                    <div class="metadata-item" style="grid-column: 1 / -1;">
                                        <div class="metadata-item-label">按节点分组</div>
                                        <div class="metadata-item-value">
                                            <details open>
                                                <summary>点击折叠/展开</summary>
                                                <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                    ${groupedModelLoaders}
                                                </div>
                                            </details>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // 技术信息
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-microchip"></i> 技术信息</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">输出节点ID</div>
                                    <div class="metadata-item-value">${metadata.node_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">存储位置</div>
                                    <div class="metadata-item-value">${metadata.subfolder ? `子文件夹: ${metadata.subfolder}` : '根目录'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">输出类型</div>
                                    <div class="metadata-item-value">${metadata.img_type === 'output' ? '生成输出' : metadata.img_type || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">ComfyUI文件名</div>
                                    <div class="metadata-item-value">${metadata.original_filename || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    metadataContent.innerHTML = html;
                    document.getElementById('metadataModal').style.display = 'block';
                } else {
                    alert('获取元数据失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('获取元数据失败:', error);
                alert('获取元数据失败: ' + error.message);
            }
        }
        
        function closeMetadataModal() {
            document.getElementById('metadataModal').style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('metadataModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // 图片选择功能
        function toggleImageSelection(filename, checkbox) {
            if (checkbox.checked) {
                selectedImages.add(filename);
                checkbox.closest('.gallery-item').classList.add('selected');
            } else {
                selectedImages.delete(filename);
                checkbox.closest('.gallery-item').classList.remove('selected');
            }
            updateBatchActions();
        }
        
        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.gallery-item-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const filename = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                selectedImages.add(filename);
                checkbox.closest('.gallery-item').classList.add('selected');
            });
            updateBatchActions();
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.gallery-item-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.gallery-item').classList.remove('selected');
            });
            selectedImages.clear();
            updateBatchActions();
        }
        
        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedImages.size > 0) {
                batchActions.style.display = 'flex';
                selectedCount.textContent = selectedImages.size;
            } else {
                batchActions.style.display = 'none';
            }
        }
        
        // 删除单个图片
        async function deleteImage(filename) {
            if (!confirm(`确定要删除图片 "${filename}" 吗？此操作不可撤销。`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('图片删除成功！');
                    loadGallery(); // 重新加载画廊
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除图片失败:', error);
                alert('删除失败: ' + error.message);
            }
        }
        
        // 删除选中的图片
        async function deleteSelectedImages() {
            if (selectedImages.size === 0) {
                alert('请先选择要删除的图片');
                return;
            }
            
            const count = selectedImages.size;
            if (!confirm(`确定要删除选中的 ${count} 张图片吗？此操作不可撤销。`)) {
                return;
            }
            
            const filenames = Array.from(selectedImages);
            
            try {
                const response = await fetch('/api/delete-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`成功删除 ${data.deleted_count} 张图片！`);
                    selectedImages.clear();
                    loadGallery(); // 重新加载画廊
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                alert('删除失败: ' + error.message);
            }
        }
        
        // 页面加载时自动加载画廊
        document.addEventListener('DOMContentLoaded', loadGallery);
        
        // 每30秒自动刷新一次
        setInterval(loadGallery, 30000);
    </script>
</body>
</html> 