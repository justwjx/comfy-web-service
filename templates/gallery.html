<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæˆå›¾ç‰‡ç”»å»Š - ComfyUI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .gallery-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .gallery-header-nav {
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            transform: translateX(-2px);
            text-decoration: none;
        }
        
        .gallery-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .gallery-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .gallery-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .gallery-item:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .gallery-item-info {
            padding: 15px;
        }
        
        .gallery-item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .gallery-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .gallery-item-parameters {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
        }
        
        .parameter-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .parameter-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .parameter-value {
            color: var(--text-secondary);
        }
        
        .metadata-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .metadata-modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .metadata-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .metadata-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .metadata-section {
            margin-bottom: 20px;
        }
        
        .metadata-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .metadata-item {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
        }
        
        .metadata-item-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .metadata-item-value {
            color: var(--text-secondary);
            word-break: break-word;
        }
        
        .gallery-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .gallery-item-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .loading-gallery {
            text-align: center;
            padding: 50px;
        }
        
        .empty-gallery {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        /* æ‰¹é‡æ“ä½œæ ·å¼ */
        .batch-actions {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        
        .batch-info {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .batch-buttons {
            display: flex;
            gap: 8px;
        }
        
        .batch-buttons .btn {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        /* å›¾ç‰‡é€‰æ‹©æ ·å¼ */
        .gallery-item.selected {
            box-shadow: 0 0 0 3px var(--primary-color);
            transform: scale(0.98);
        }
        
        .gallery-item-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .gallery-item-checkbox input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .gallery-item {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="gallery-container">
        <div class="gallery-header">
            <div class="gallery-header-nav">
                <a href="/" class="btn btn-secondary back-btn">
                    <i class="fas fa-arrow-left"></i>
                    è¿”å›å·¥ä½œæµ
                </a>
            </div>
            <h1><i class="fas fa-images"></i> ç”Ÿæˆå›¾ç‰‡ç”»å»Š</h1>
            <p>æŸ¥çœ‹æ‰€æœ‰é€šè¿‡ComfyUIç”Ÿæˆçš„å›¾ç‰‡</p>
            <div style="font-size:11px;color:var(--text-secondary);opacity:.8;margin-top:6px;">
                å°è´´å£«ï¼šç‚¹å‡»å›¾ç‰‡å¯æ–°çª—å£æŸ¥çœ‹åŸå›¾ï¼›ç‚¹å‡»â€œå‚æ•°â€å¯å±•å¼€ç”Ÿæˆæ—¶çš„æç¤ºè¯ä¸æ¨¡å‹é…ç½®ã€‚
            </div>
        </div>
        
        <div class="gallery-stats" id="galleryStats">
            <div class="stat-item">
                <i class="fas fa-images"></i>
                <span id="totalImages">-</span> å¼ å›¾ç‰‡
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span id="latestImage">-</span>
            </div>
        </div>
        
        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div class="batch-actions" id="batchActions" style="display: none;">
            <div class="batch-info">
                <span id="selectedCount">0</span> å¼ å›¾ç‰‡å·²é€‰ä¸­
            </div>
            <div class="batch-buttons">
                <button class="btn btn-secondary btn-sm" onclick="selectAllImages()">
                    <i class="fas fa-check-square"></i>
                    å…¨é€‰
                </button>
                <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
                    <i class="fas fa-times"></i>
                    æ¸…é™¤é€‰æ‹©
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedImages()">
                    <i class="fas fa-trash"></i>
                    åˆ é™¤é€‰ä¸­
                </button>
            </div>
        </div>
        
        <div id="galleryContent">
            <div class="loading-gallery">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
            </div>
        </div>
    </div>
    
    <button class="btn btn-primary refresh-btn" onclick="loadGallery()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- å…ƒæ•°æ®æ¨¡æ€æ¡† -->
    <div id="metadataModal" class="metadata-modal">
        <div class="metadata-modal-content">
            <div class="metadata-modal-header">
                <h2><i class="fas fa-info-circle"></i> å›¾ç‰‡ç”Ÿæˆå‚æ•°</h2>
                <button class="metadata-modal-close" onclick="closeMetadataModal()">&times;</button>
            </div>
            <div id="metadataContent">
                <!-- å…ƒæ•°æ®å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedImages = new Set();
        let allImages = [];
        
        async function loadGallery() {
            const galleryContent = document.getElementById('galleryContent');
            const totalImages = document.getElementById('totalImages');
            const latestImage = document.getElementById('latestImage');
            
            try {
                galleryContent.innerHTML = `
                    <div class="loading-gallery">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
                    </div>
                `;
                
                const response = await fetch('/api/generated-images');
                const data = await response.json();
                
                if (data.success) {
                    const images = data.images;
                    allImages = images; // ä¿å­˜åˆ°å…¨å±€å˜é‡
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    totalImages.textContent = data.total;
                    if (images.length > 0) {
                        const latest = new Date(images[0].modified_time);
                        latestImage.textContent = latest.toLocaleString();
                    }
                    
                    if (images.length === 0) {
                        galleryContent.innerHTML = `
                            <div class="empty-gallery">
                                <i class="fas fa-images" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                <h3>æš‚æ— ç”Ÿæˆå›¾ç‰‡</h3>
                                <p>å¼€å§‹ä½¿ç”¨ComfyUIç”Ÿæˆæ‚¨çš„ç¬¬ä¸€å¼ å›¾ç‰‡å§ï¼</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 20px;">
                                    <i class="fas fa-play"></i> å¼€å§‹ç”Ÿæˆ
                                </a>
                            </div>
                        `;
                        return;
                    }
                    
                    // æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                    const galleryGrid = document.createElement('div');
                    galleryGrid.className = 'gallery-grid';
                    
                    images.forEach(image => {
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        
                        const createdTime = new Date(image.modified_time);
                        const fileSize = (image.size / 1024 / 1024).toFixed(1);
                        
                        // æ„å»ºå‚æ•°æ˜¾ç¤º
                        let parametersHtml = '';
                        if (image.has_metadata && (image.prompt || image.steps || image.cfg || image.seed)) {
                            // å¤„ç†ç§å­æ˜¾ç¤º
                            let seedDisplay = '';
                            if (image.seed !== undefined && image.seed !== null) {
                                if (image.seed === -1 && image.metadata && image.metadata.parameters && image.metadata.parameters.actual_seed) {
                                    // ç”¨æˆ·è®¾ç½®-1ï¼Œæ˜¾ç¤ºå®é™…ç§å­å€¼
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed} â†’ ${image.metadata.parameters.actual_seed}</span></div>`;
                                } else {
                                    // ç”¨æˆ·è®¾ç½®äº†å…·ä½“å€¼
                                    seedDisplay = `<div class="parameter-item"><span class="parameter-label">Seed:</span><span class="parameter-value">${image.seed}</span></div>`;
                                }
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡å‹ä¿¡æ¯
                            let modelInfo = '';
                            // å…¼å®¹ï¼šä¼˜å…ˆè¯»å–æ–°çš„ model_summary / å…¶æ¬¡è¯»å– model_loaders(by_node)
                            if (image.metadata) {
                                if (image.metadata.model_summary) {
                                    const ms = image.metadata.model_summary;
                                    const mainModel = ms.main_model || 'N/A';
                                    const vae = ms.vae || null;
                                    const loras = Array.isArray(ms.loras) ? ms.loras.filter(Boolean) : [];
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}${loras.length ? ` | LoRA: ${loras.slice(0,2).join(', ')}${loras.length>2?'â€¦':''}` : ''}</span></div>`;
                                } else if (image.metadata.model_loaders) {
                                    const ml = image.metadata.model_loaders; // by_node å±•å¼€
                                    const mainModel = ml.model_path_45 || ml.ckpt_name_45 || ml.model_type_44 || 'N/A';
                                    const vae = ml.vae_name_10 || null;
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}</span></div>`;
                                } else if (image.metadata.parameters && image.metadata.parameters.model_loaders) {
                                    // æ—§ç»“æ„å‘åå…¼å®¹
                                    const ml = image.metadata.parameters.model_loaders;
                                    const mainModel = ml.model_path_45 || ml.ckpt_name_45 || ml.model_type_44 || 'N/A';
                                    const vae = ml.vae_name_10 || null;
                                    modelInfo = `<div class="parameter-item"><span class="parameter-label">Model:</span><span class="parameter-value">${mainModel}${vae ? ` | VAE: ${vae}` : ''}</span></div>`;
                                }
                            }
                            
                            parametersHtml = `
                                <div class="gallery-item-parameters">
                                    ${image.prompt ? `<div class="parameter-item"><span class="parameter-label">Prompt:</span><span class="parameter-value">${image.prompt.substring(0, 50)}${image.prompt.length > 50 ? '...' : ''}</span></div>` : ''}
                                    ${image.steps ? `<div class="parameter-item"><span class="parameter-label">Steps:</span><span class="parameter-value">${image.steps}</span></div>` : ''}
                                    ${image.cfg ? `<div class="parameter-item"><span class="parameter-label">CFG:</span><span class="parameter-value">${image.cfg}</span></div>` : ''}
                                    ${seedDisplay}
                                    ${image.sampler ? `<div class="parameter-item"><span class="parameter-label">Sampler:</span><span class="parameter-value">${image.sampler}</span></div>` : ''}
                                    ${modelInfo}
                                </div>
                            `;
                        }
                        
                        item.innerHTML = `
                            <div class="gallery-item-checkbox">
                                <input type="checkbox" onchange="toggleImageSelection('${image.filename}', this)" />
                            </div>
                            <img src="${image.url}" alt="${image.filename}" onclick="viewImage('${image.url}')">
                            <div class="gallery-item-info">
                                <div class="gallery-item-title">${image.filename}</div>
                                <div class="gallery-item-meta">
                                    <div>ç”Ÿæˆæ—¶é—´: ${createdTime.toLocaleString()}</div>
                                    <div>æ–‡ä»¶å¤§å°: ${fileSize} MB</div>
                                    ${image.workflow ? `<div>å·¥ä½œæµ: ${image.workflow}</div>` : ''}
                                </div>
                                ${parametersHtml}
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-primary" onclick="viewImage('${image.url}')">
                                        <i class="fas fa-eye"></i> æŸ¥çœ‹
                                    </button>
                                    ${image.has_metadata ? `<button class="btn btn-sm btn-info" onclick="viewMetadata('${image.filename}')">
                                        <i class="fas fa-info-circle"></i> å‚æ•°
                                    </button>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="downloadImage('${image.url}')">
                                        <i class="fas fa-download"></i> ä¸‹è½½
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.filename}')">
                                        <i class="fas fa-trash"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        galleryGrid.appendChild(item);
                    });
                    
                    galleryContent.innerHTML = '';
                    galleryContent.appendChild(galleryGrid);
                } else {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç”»å»Šå¤±è´¥:', error);
                galleryContent.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadGallery()">
                            <i class="fas fa-redo"></i> é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
        
        function viewImage(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        function downloadImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageUrl.split('/').pop() || 'generated_image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // é€šç”¨åˆ†ç»„ï¼ˆä¸ä¾èµ–å›ºå®šèŠ‚ç‚¹IDï¼‰ï¼Œæ›´å¥½é€‚é…ä¸åŒå·¥ä½œæµ
        function groupModelLoaders(modelLoaders) {
            const groups = {
                vae: [],
                main_model: [],
                text_encoder: [],
                lora: [],
                other: []
            };

            Object.entries(modelLoaders).forEach(([key, value]) => {
                const lower = String(key).toLowerCase();
                if (lower.startsWith('vae_name_')) {
                    groups.vae.push({ key, value });
                } else if (lower.startsWith('model_path_') || lower.startsWith('ckpt_name_')) {
                    groups.main_model.push({ key, value });
                } else if (lower.startsWith('clip_name') || lower.startsWith('text_encoder')) {
                    groups.text_encoder.push({ key, value });
                } else if (lower.startsWith('lora_name_')) {
                    groups.lora.push({ key, value });
                } else {
                    groups.other.push({ key, value });
                }
            });

            let html = '';
            const renderBlock = (title, color, items) => {
                if (!items || items.length === 0) return '';
                let block = `<div style="margin-bottom: 15px;"><h4 style="color: ${color}; margin: 0 0 8px 0; font-size: 14px;">${title}</h4>`;
                items.forEach(({ key, value }) => {
                    block += `<div style="margin: 2px 0;"><strong>${key.replace(/_/g, ' ')}:</strong> ${value}</div>`;
                });
                block += '</div>';
                return block;
            };

            html += renderBlock('ğŸ”§ VAE', '#007bff', groups.vae);
            html += renderBlock('ğŸ¤– ä¸»æ¨¡å‹', '#dc3545', groups.main_model);
            html += renderBlock('ğŸ“ æ–‡æœ¬ç¼–ç å™¨', '#28a745', groups.text_encoder);
            html += renderBlock('ğŸ¨ LoRA', '#ffc107', groups.lora);
            html += renderBlock('ğŸ“¦ å…¶ä»–', '#6c757d', groups.other);

            return html || '<div style="color: var(--text-secondary);">æ— å¯å±•ç¤ºçš„æ¨¡å‹é…ç½®</div>';
        }
        
        async function viewMetadata(filename) {
            try {
                const response = await fetch(`/api/image-metadata/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    const metadata = data.metadata;
                    const metadataContent = document.getElementById('metadataContent');
                    
                    // æ„å»ºå…ƒæ•°æ®HTML
                    let html = '';
                    
                    // åŸºæœ¬ä¿¡æ¯
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-file-image"></i> åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">æ–‡ä»¶å</div>
                                    <div class="metadata-item-value">${metadata.output_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">å·¥ä½œæµ</div>
                                    <div class="metadata-item-value">${metadata.workflow_filename || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">ä»»åŠ¡ID</div>
                                    <div class="metadata-item-value">${metadata.task_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">åˆ›å»ºæ—¶é—´</div>
                                    <div class="metadata-item-value">${new Date(metadata.created_time).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ç”Ÿæˆå‚æ•°
                    const parameters = metadata.parameters || {};
                    if (Object.keys(parameters).length > 0) {
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-cogs"></i> ç”Ÿæˆå‚æ•°</h3>
                                <div class="metadata-grid">
                        `;
                        
                        // æ˜¾ç¤ºæ‰€æœ‰å‚æ•°
                        for (const [key, value] of Object.entries(parameters)) {
                            if (value !== null && value !== undefined && value !== '') {
                                // ç‰¹æ®Šå¤„ç†ç§å­æ˜¾ç¤º
                                if (key === 'seed' && parameters.user_seed === -1 && parameters.actual_seed) {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">ç”¨æˆ·è®¾ç½®ç§å­</div>
                                            <div class="metadata-item-value">${parameters.user_seed}</div>
                                        </div>
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">å®é™…ä½¿ç”¨ç§å­</div>
                                            <div class="metadata-item-value">${parameters.actual_seed}</div>
                                        </div>
                                    `;
                                } else if (key === 'user_seed' || key === 'actual_seed') {
                                    // è·³è¿‡è¿™äº›å­—æ®µï¼Œå› ä¸ºå·²ç»åœ¨ä¸Šé¢å¤„ç†äº†
                                    continue;
                                } else if (key === 'model_loaders') {
                                    // ç‰¹æ®Šå¤„ç†model_loaderså¯¹è±¡ï¼ŒæŒ‰èŠ‚ç‚¹åˆ†ç»„
                                    const groupedModelLoaders = groupModelLoaders(value);
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">æ¨¡å‹åŠ è½½å™¨</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ¨¡å‹é…ç½®</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${groupedModelLoaders}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else if (typeof value === 'object') {
                                    // å¤„ç†å…¶ä»–å¯¹è±¡ç±»å‹
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">
                                                <details>
                                                    <summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</summary>
                                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                        ${JSON.stringify(value, null, 2)}
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    html += `
                                        <div class="metadata-item">
                                            <div class="metadata-item-label">${key}</div>
                                            <div class="metadata-item-value">${value}</div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // æ¨¡å‹æ‘˜è¦ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
                    if (metadata.model_summary) {
                        const ms = metadata.model_summary;
                        const loras = Array.isArray(ms.loras) ? ms.loras.filter(Boolean) : [];
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-layer-group"></i> æ¨¡å‹åŠ è½½å™¨ï¼ˆæ‘˜è¦ï¼‰</h3>
                                <div class="metadata-grid">
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">ä¸»æ¨¡å‹</div>
                                        <div class="metadata-item-value">${ms.main_model || 'N/A'}</div>
                                    </div>
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">VAE</div>
                                        <div class="metadata-item-value">${ms.vae || 'N/A'}</div>
                                    </div>
                                    ${loras.length ? `
                                    <div class="metadata-item">
                                        <div class="metadata-item-label">LoRA</div>
                                        <div class="metadata-item-value">${loras.join(', ')}</div>
                                    </div>` : ''}
                                </div>
                            </div>
                        `;
                    }

                    // è¯¦ç»†æ¨¡å‹åŠ è½½å™¨ï¼ˆby_node æç¤ºï¼‰
                    if (metadata.model_loaders && typeof metadata.model_loaders === 'object') {
                        const groupedModelLoaders = groupModelLoaders(metadata.model_loaders);
                        html += `
                            <div class="metadata-section">
                                <h3><i class="fas fa-tools"></i> æ¨¡å‹åŠ è½½å™¨ï¼ˆè¯¦ç»†ï¼‰</h3>
                                <div class="metadata-grid">
                                    <div class="metadata-item" style="grid-column: 1 / -1;">
                                        <div class="metadata-item-label">æŒ‰èŠ‚ç‚¹åˆ†ç»„</div>
                                        <div class="metadata-item-value">
                                            <details open>
                                                <summary>ç‚¹å‡»æŠ˜å /å±•å¼€</summary>
                                                <div style="margin-top: 10px; padding: 10px; background: var(--bg-color); border-radius: 4px; font-size: 12px;">
                                                    ${groupedModelLoaders}
                                                </div>
                                            </details>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // æŠ€æœ¯ä¿¡æ¯
                    html += `
                        <div class="metadata-section">
                            <h3><i class="fas fa-microchip"></i> æŠ€æœ¯ä¿¡æ¯</h3>
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-item-label">è¾“å‡ºèŠ‚ç‚¹ID</div>
                                    <div class="metadata-item-value">${metadata.node_id || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">å­˜å‚¨ä½ç½®</div>
                                    <div class="metadata-item-value">${metadata.subfolder ? `å­æ–‡ä»¶å¤¹: ${metadata.subfolder}` : 'æ ¹ç›®å½•'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">è¾“å‡ºç±»å‹</div>
                                    <div class="metadata-item-value">${metadata.img_type === 'output' ? 'ç”Ÿæˆè¾“å‡º' : metadata.img_type || 'N/A'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-item-label">ComfyUIæ–‡ä»¶å</div>
                                    <div class="metadata-item-value">${metadata.original_filename || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    metadataContent.innerHTML = html;
                    document.getElementById('metadataModal').style.display = 'block';
                } else {
                    alert('è·å–å…ƒæ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è·å–å…ƒæ•°æ®å¤±è´¥:', error);
                alert('è·å–å…ƒæ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        function closeMetadataModal() {
            document.getElementById('metadataModal').style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('metadataModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // å›¾ç‰‡é€‰æ‹©åŠŸèƒ½
        function toggleImageSelection(filename, checkbox) {
            if (checkbox.checked) {
                selectedImages.add(filename);
                checkbox.closest('.gallery-item').classList.add('selected');
            } else {
                selectedImages.delete(filename);
                checkbox.closest('.gallery-item').classList.remove('selected');
            }
            updateBatchActions();
        }
        
        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.gallery-item-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const filename = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                selectedImages.add(filename);
                checkbox.closest('.gallery-item').classList.add('selected');
            });
            updateBatchActions();
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.gallery-item-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.gallery-item').classList.remove('selected');
            });
            selectedImages.clear();
            updateBatchActions();
        }
        
        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedImages.size > 0) {
                batchActions.style.display = 'flex';
                selectedCount.textContent = selectedImages.size;
            } else {
                batchActions.style.display = 'none';
            }
        }
        
        // åˆ é™¤å•ä¸ªå›¾ç‰‡
        async function deleteImage(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('å›¾ç‰‡åˆ é™¤æˆåŠŸï¼');
                    loadGallery(); // é‡æ–°åŠ è½½ç”»å»Š
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤é€‰ä¸­çš„å›¾ç‰‡
        async function deleteSelectedImages() {
            if (selectedImages.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡');
                return;
            }
            
            const count = selectedImages.size;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            const filenames = Array.from(selectedImages);
            
            try {
                const response = await fetch('/api/delete-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`æˆåŠŸåˆ é™¤ ${data.deleted_count} å¼ å›¾ç‰‡ï¼`);
                    selectedImages.clear();
                    loadGallery(); // é‡æ–°åŠ è½½ç”»å»Š
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç”»å»Š
        document.addEventListener('DOMContentLoaded', loadGallery);
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
        setInterval(loadGallery, 30000);
    </script>
</body>
</html> 